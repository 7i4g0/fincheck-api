// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String   @id @default(uuid()) @db.Uuid
  email               String   @unique
  name                String?
  password            String
  onboardingCompleted Boolean  @default(false) @map("onboarding_completed")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  bankAccounts           BankAccount[]
  categories             Category[]
  transactions           Transaction[]
  creditCards            CreditCard[]
  creditCardTransactions CreditCardTransaction[]

  @@map("users")
}

enum BankAccountType {
  CHECKING
  INVESTMENT
  CASH

  @@map("bank_account_types")
}

model BankAccount {
  id             String          @id @default(uuid()) @db.Uuid
  userId         String          @map("user_id") @db.Uuid
  name           String
  initialBalance Float           @map("initial_balance")
  type           BankAccountType
  color          String
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  users                   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceTransactions      Transaction[] @relation("SourceTransactions")
  destinationTransactions Transaction[] @relation("DestinationTransactions")
  creditCards             CreditCard[]  @relation("DefaultBankAccount")

  @@map("bank_accounts")
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER

  @@map("transaction_types")
}

model Category {
  id        String          @id @default(uuid()) @db.Uuid
  userId    String          @map("user_id") @db.Uuid
  name      String
  icon      String
  type      TransactionType
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  users                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions           Transaction[]
  creditCardTransactions CreditCardTransaction[]

  @@map("categories")
}

model Transaction {
  id                       String          @id @default(uuid()) @db.Uuid
  userId                   String          @map("user_id") @db.Uuid
  bankAccountId            String          @map("bank_account_id") @db.Uuid
  destinationBankAccountId String?         @map("destination_bank_account_id") @db.Uuid // For TRANSFER type
  categoryId               String?         @map("category_id") @db.Uuid
  creditCardId             String?         @map("credit_card_id") @db.Uuid // If it is an invoice for a credit card
  invoiceMonth             Int?            @map("invoice_month") // Invoice month (1-12)
  invoiceYear              Int?            @map("invoice_year") // Invoice year
  name                     String
  value                    Float
  date                     DateTime
  type                     TransactionType
  createdAt                DateTime        @default(now()) @map("created_at")
  updatedAt                DateTime        @updatedAt @map("updated_at")

  user                   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccount            BankAccount  @relation("SourceTransactions", fields: [bankAccountId], references: [id], onDelete: Cascade)
  destinationBankAccount BankAccount? @relation("DestinationTransactions", fields: [destinationBankAccountId], references: [id], onDelete: Cascade)
  category               Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  creditCard             CreditCard?  @relation("InvoiceTransactions", fields: [creditCardId], references: [id], onDelete: SetNull)

  @@unique([creditCardId, invoiceMonth, invoiceYear]) // An invoice transaction by card/month/year
  @@map("transactions")
}

model CreditCard {
  id                   String   @id @default(uuid()) @db.Uuid
  userId               String   @map("user_id") @db.Uuid
  defaultBankAccountId String?  @map("default_bank_account_id") @db.Uuid
  name                 String
  color                String
  limit                Float    @default(0)
  closingDay           Int      @map("closing_day") // Closing day (1-28)
  dueDay               Int      @map("due_day") // Due day (1-28)
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  user                User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  defaultBankAccount  BankAccount?            @relation("DefaultBankAccount", fields: [defaultBankAccountId], references: [id], onDelete: SetNull)
  transactions        CreditCardTransaction[]
  invoiceTransactions Transaction[]           @relation("InvoiceTransactions")

  @@map("credit_cards")
}

model CreditCardTransaction {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @map("user_id") @db.Uuid
  creditCardId       String   @map("credit_card_id") @db.Uuid
  categoryId         String?  @map("category_id") @db.Uuid
  name               String
  value              Float
  date               DateTime // Purchase date
  installments       Int      @default(1) // Total installments
  currentInstallment Int      @default(1) @map("current_installment") // Current installment
  installmentGroupId String?  @map("installment_group_id") @db.Uuid // Group installments of the same purchase
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditCard CreditCard @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  category   Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@map("credit_card_transactions")
}
